# INSERT and UPDATE with Constraint Validation Tests

# Setup test tables with constraints
statement ok
CREATE TABLE departments (
    id INTEGER PRIMARY KEY,
    name VARCHAR UNIQUE NOT NULL,
    budget DECIMAL CHECK (budget > 0) DEFAULT 100000.0
);

statement ok
CREATE TABLE employees (
    id INTEGER PRIMARY KEY,
    name VARCHAR NOT NULL,
    email VARCHAR UNIQUE NOT NULL,
    age INTEGER CHECK (age >= 18 AND age <= 65),
    salary DECIMAL CHECK (salary > 0),
    department_id INTEGER REFERENCES departments(id),
    status VARCHAR DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'terminated'))
);

# Valid INSERT operations

# Test INSERT with all constraints satisfied
statement ok
INSERT INTO departments (id, name, budget) VALUES (1, 'Engineering', 500000.0);

statement ok
INSERT INTO departments (id, name, budget) VALUES (2, 'Sales', 300000.0);

statement ok
INSERT INTO employees (id, name, email, age, salary, department_id, status)
VALUES (1, 'Alice Smith', 'alice@company.com', 28, 75000.0, 1, 'active');

# Test INSERT with DEFAULT values
statement ok
INSERT INTO employees (id, name, email, age, salary, department_id)
VALUES (2, 'Bob Johnson', 'bob@company.com', 32, 68000.0, 2);

# Test INSERT with only required fields (using defaults)
statement ok
INSERT INTO departments (id, name) VALUES (3, 'Marketing');

# Constraint Violation Tests - INSERT

# Test NOT NULL constraint violation
statement error
INSERT INTO employees (id, email, age, salary, department_id)
VALUES (3, 'charlie@company.com', 25, 60000.0, 1);

# Test UNIQUE constraint violation
statement error
INSERT INTO employees (id, name, email, age, salary, department_id)
VALUES (4, 'David Wilson', 'alice@company.com', 30, 70000.0, 1);

# Test CHECK constraint violation - age too young
statement error
INSERT INTO employees (id, name, email, age, salary, department_id)
VALUES (5, 'Young Person', 'young@company.com', 16, 50000.0, 1);

# Test CHECK constraint violation - age too old
statement error
INSERT INTO employees (id, name, email, age, salary, department_id)
VALUES (6, 'Old Person', 'old@company.com', 70, 80000.0, 1);

# Test CHECK constraint violation - negative salary
statement error
INSERT INTO employees (id, name, email, age, salary, department_id)
VALUES (7, 'Poor Person', 'poor@company.com', 25, -1000.0, 1);

# Test CHECK constraint violation - invalid status
statement error
INSERT INTO employees (id, name, email, age, salary, department_id, status)
VALUES (8, 'Invalid Status', 'invalid@company.com', 25, 55000.0, 1, 'unknown');

# Test FOREIGN KEY constraint violation
statement error
INSERT INTO employees (id, name, email, age, salary, department_id)
VALUES (9, 'No Department', 'nodept@company.com', 25, 55000.0, 999);

# Test PRIMARY KEY constraint violation
statement error
INSERT INTO employees (id, name, email, age, salary, department_id)
VALUES (1, 'Duplicate ID', 'duplicate@company.com', 25, 55000.0, 1);

# Valid UPDATE operations

# Test UPDATE with constraints satisfied
statement ok
UPDATE employees SET salary = 80000.0 WHERE id = 1;

# Test UPDATE with CHECK constraint satisfied
statement ok
UPDATE employees SET age = 29 WHERE id = 1;

# Test UPDATE with status change
statement ok
UPDATE employees SET status = 'inactive' WHERE id = 2;

# Constraint Violation Tests - UPDATE

# Test UPDATE violating CHECK constraint - age too young
statement error
UPDATE employees SET age = 15 WHERE id = 1;

# Test UPDATE violating CHECK constraint - negative salary
statement error
UPDATE employees SET salary = -5000.0 WHERE id = 1;

# Test UPDATE violating UNIQUE constraint
statement error
UPDATE employees SET email = 'bob@company.com' WHERE id = 1;

# Test UPDATE violating CHECK constraint - invalid status
statement error
UPDATE employees SET status = 'retired' WHERE id = 1;

# Test UPDATE violating FOREIGN KEY constraint
statement error
UPDATE employees SET department_id = 999 WHERE id = 1;

# Test UPDATE violating NOT NULL constraint
statement error
UPDATE employees SET name = NULL WHERE id = 1;

# Test UPDATE violating CHECK constraint on departments
statement error
UPDATE departments SET budget = -1000.0 WHERE id = 1;

# Test batch operations with constraints

# Valid batch INSERT
statement ok
INSERT INTO employees (id, name, email, age, salary, department_id) VALUES
(10, 'John Doe', 'john@company.com', 30, 65000.0, 1),
(11, 'Jane Smith', 'jane@company.com', 28, 72000.0, 2),
(12, 'Mike Brown', 'mike@company.com', 35, 78000.0, 3);

# Test batch UPDATE with constraints
statement ok
UPDATE employees SET salary = salary * 1.1 WHERE department_id = 1;

# Complex constraint scenarios

# Test UPDATE with multiple constraints
statement ok
UPDATE employees
SET age = 31, salary = 85000.0, status = 'active'
WHERE id = 11 AND age >= 18 AND salary > 0;

# Test INSERT after constraint-validating UPDATE
statement ok
INSERT INTO employees (id, name, email, age, salary, department_id)
VALUES (13, 'Sarah Wilson', 'sarah@company.com', 26, 69000.0, 2);

# Test UPDATE cascading effects (if implemented)
statement ok
UPDATE departments SET name = 'Engineering & Tech' WHERE id = 1;

# Edge cases with constraints

# Test INSERT with minimum valid values
statement ok
INSERT INTO employees (id, name, email, age, salary, department_id)
VALUES (14, 'Min Values', 'min@company.com', 18, 1.0, 1);

# Test INSERT with maximum valid values
statement ok
INSERT INTO employees (id, name, email, age, salary, department_id)
VALUES (15, 'Max Values', 'max@company.com', 65, 999999.99, 1);

# Test UPDATE to boundary values
statement ok
UPDATE employees SET age = 65 WHERE id = 14;

statement ok
UPDATE employees SET age = 18 WHERE id = 15;

# Test NULL handling in optional fields
statement ok
INSERT INTO employees (id, name, email, age, salary)
VALUES (16, 'No Department', 'nodept_valid@company.com', 25, 55000.0);

# Test UPDATE setting optional field to NULL
statement ok
UPDATE employees SET department_id = NULL WHERE id = 16;

# Complex multi-table constraint scenarios

# Test INSERT that depends on existing data
statement ok
INSERT INTO departments (id, name, budget) VALUES (4, 'HR', 200000.0);

statement ok
INSERT INTO employees (id, name, email, age, salary, department_id)
VALUES (17, 'HR Manager', 'hr@company.com', 40, 90000.0, 4);

# Test UPDATE with join-like constraints (if supported)
statement ok
UPDATE employees
SET salary = 95000.0
WHERE id = 17 AND department_id IN (SELECT id FROM departments WHERE name = 'HR');

# Cleanup and final validation

# Verify constraint enforcement didn't break valid data
query IITII
SELECT id, name, age, salary, department_id
FROM employees
WHERE id <= 3
ORDER BY id;
----
1 Alice Smith 29 80000 1
2 Bob Johnson 32 68000 2

# Verify department constraints are still enforced
query IT
SELECT id, name
FROM departments
WHERE id <= 3
ORDER BY id;
----
1 Engineering & Tech
2 Sales
3 Marketing
